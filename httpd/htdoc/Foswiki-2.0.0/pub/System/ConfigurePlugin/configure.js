var json_rpc_url="jsonrpc",jsonRpc_reqnum=0,$FALSE=0,$TRUE=1;function _id_ify(id){if(typeof id==="undefined"){debugger}id=id.replace(/[}{]/g,"-");id=id.replace(/['"]/g,"");id=id.replace(/[^A-Za-z0-9_]/g,"-");return"i"+id}(function($){"use strict";var auth_action=function(){},confirm_action=function(){};function inline_whirly($site){var $whirly=$('<span class="whirly" />');$site.append($whirly);window.setTimeout(function(){$whirly.remove()},1e3);return $whirly}function find_modified_values(){var set={},handler;$(".value_modified").each(function(){handler=$(this).data("value_handler");set[handler.spec.keys]=handler.currentValue()});return set}function update_save_button(){var count=$(".value_modified").length,mess=count==1?"1 change":count>0?count+" changes":"";$("#saveButton").button("option","label","Save "+mess);if($("#bootstrap_warning").length>0){count++}$("#saveButton").button(count>0?"enable":"disable")}function update_modified_default($node){var handler=$node.data("value_handler");if(handler.isModified()){$node.addClass("value_modified");$node.find(".undo_button").show();update_save_button()}else{$node.removeClass("value_modified");update_save_button();$node.find(".undo_button").hide()}if(handler.isDefault()){$node.find(".default_button").hide()}else{$node.find(".default_button").show()}}function RPC(method,message,params,report,$whirlyPlace){var rpcid,$w;rpcid=_id_ify(message)+"_"+jsonRpc_reqnum++;console.debug("Sending "+rpcid);if($whirlyPlace){$w=inline_whirly($whirlyPlace)}$.jsonRpc(json_rpc_url,{namespace:"configure",method:method,id:rpcid,params:params,error:function(jsonResponse,textStatus,xhr){console.debug(rpcid+" failed");if($w){$w.remove()}$.pnotify({title:"Error",text:jsonResponse.error.message,type:"error",hide:false,sticker:false,closer_hover:false,icon:false})},success:function(jsonResponse,textStatus,xhr){console.debug(rpcid+" OK");report(jsonResponse.result);if($w){$w.remove()}}})}function forget_checker_reports($tab,level,id){$tab.removeClass(level+id);var report_data=$tab.data("reports");report_data[level][id]--;if(report_data[level][id]){delete report_data[level][id]}if(report_data[level].length===0){$tab.removeClass(level)}}function record_checker_reports($tab,level,id){$tab.addClass(level+id);var report_data=$tab.data("reports");if(!report_data){report_data={errors:{},warnings:{}};$tab.data("reports",report_data)}report_data[level][id]=true;$tab.addClass(level);$tab.closest("li").addClass(level)}function bubble_checker_reports(r,has){var path=r.path.join(" > "),id=_id_ify(r.keys),sid,$whine;$.each(r.path,function(index,pel){sid=_id_ify(pel);$.each(has,function(level,count){if(count===0||level==="notes"){return}record_checker_reports($("#TAB"+sid),level,id);$("#REP"+sid).first().each(function(){var s=count==1?level.substr(0,level.length-1):level;$whine=$("<div>"+path+" > "+r.keys+" has "+count+" "+s+"</div>");$whine.addClass(level);$whine.addClass(id+"_report");$(this).append($whine)})})})}function checker_reports(results){$("body").css("cursor","wait");$.each(results,function(index,r){var $div,id,has,$reports,$whine;if(!r.keys){$div=$('<div id="report_dialog"></div>');$div.html(TML.render_reports(r.reports));$div.dialog({modal:true,width:"auto",buttons:{Close:function(){$div.dialog("close");$div.remove()}},close:function(){$("body").css("cursor","auto")}});return}id=_id_ify(r.keys);$("."+id+"_report").remove();$(".errors"+id).each(function(){forget_checker_reports($(this),"errors",id)});$(".warnings"+id).each(function(){forget_checker_reports($(this),"warnings",id)});$("#"+id+"_block").removeClass("errors").removeClass("warnings").removeClass("notes");has={errors:0,warnings:0};if(r.reports){$reports=$("#REP"+id);$.each(r.reports,function(index,rep){has[rep.level]++;$("#"+id+"_block").addClass(rep.level)});if($reports.length>0){$whine=$("<div></div>");$whine.html(TML.render_reports(r.reports));$whine.addClass(id+"_report");$whine.addClass("message_block");$reports.append($whine)}}if(has.errors+has.warnings>0&&r.path){bubble_checker_reports(r,has)}});$("body").css("cursor","auto")}function check_current_value($node,dep){update_modified_default($node);var handler=$node.data("value_handler"),params={keys:[handler.spec.keys],set:find_modified_values(),check_dependencies:dep};RPC("check_current_value","Check: "+handler.spec.keys,params,checker_reports,$node)}function wizard_started(params){var id=params.wizard+"_"+params.method;var $dlg=$("#hogwarts");var $div=$('<div class="wiz"></div>');$div.addClass(id);$div.html("<b>Waiting for the server, please be patient:</b><br/>");$div.append((params.wizard?params.wizard+"/":"")+params.method+" is working");inline_whirly($div);$dlg.append($div);if(!$dlg.hasClass("ui-dialog-content")){$dlg.dialog({title:"Active Wizards",width:"auto"})}else if(!$dlg.dialog("isOpen"))$dlg.dialog("open")}function wizard_finished(params){var id=params.wizard+"_"+params.method;var $dlg=$("#hogwarts");$dlg.find("."+id).remove();if($dlg.find(".wiz").length==0){$dlg.dialog("close")}}function wizard_reports(params,$node,results){var $div=$('<div class="message_block"></div>'),$dlg;$("body").css("cursor","wait");$div.html(TML.render_reports(results.messages));if(results.changes){$.each(results.changes,function(key,value){$div.append('<div class="changes">'+key+" = "+value+"</div>")})}$div.find(".wizard_button").each(function(){var data=$(this).data("wizard"),o,params;$(this).button().click(function(){var wiz;if(data.form){o=$.extend({},data.args);$.each($(data.form).serializeArray(),function(){if(o[this.name]!==undefined){if(!o[this.name].push){o[this.name]=[o[this.name]]}o[this.name].push(this.value||"")}else{o[this.name]=this.value||""}})}else{o=data.args}params={wizard:data.wizard,method:data.method,args:o,set:find_modified_values(),cfgusername:$("#username").val(),cfgpassword:$("#password").val()};wizard_started(params);RPC("wizard","Call "+data.method,params,function(result){wizard_reports(params,$node,result)},$(this))})});$.each(results.changes,function(keys,value){var spotted=false,pendid,$pending,handler;$("#"+_id_ify(keys)).closest(".node").each(function(){var $node=$(this),handler=$node.data("value_handler");handler.useVal(value);spotted=true;check_current_value($node,true)});if(!spotted){pendid="pending"+_id_ify(keys);$pending=$("#"+pendid);if($pending.length===0){$pending=$('<div class="hidden_pending value_modified" id="'+pendid+'"></div>');$("#root").append($pending)}handler={spec:{keys:keys},currentValue:function(){return value},isDefault:function(){return true},isModified:function(){return true},commitVal:function(){$pending.removeClass("value_modified")}};$pending.data("value_handler",handler);update_save_button()}});wizard_finished(params);$dlg=$('<div id="report_dialog"></div>');$dlg.append($div);$dlg.dialog({title:"Validation",width:"auto",modal:true,buttons:{Close:function(){$dlg.dialog("close");$dlg.remove()}},close:function(){$("body").css("cursor","auto")}})}function call_wizard($node,fb,$whirlyPlace){var handler=$node.data("value_handler"),params={wizard:fb.wizard,method:fb.method,keys:handler?handler.spec.keys:"",set:find_modified_values(),cfgusername:$("#username").val(),cfgpassword:$("#password").val()};wizard_started(params);RPC("wizard","Call "+fb.method,params,function(result){wizard_reports(params,$node,result)},$whirlyPlace)}function create_feedback(spec,fb,$node){var $button;if(fb.method){if(!fb.label){fb.label=fb.method}if(!fb.label){fb.label=fb.wizard}$button=$('<button class="feedback_button">'+fb.label+"</button>");if(fb.title){$button.attr("title",fb.title)}$button.click(function(){if(fb.auth==1){auth_action=function(){call_wizard($node,fb,$node)};$("#auth_note").html(spec.title);$("#auth_prompt").dialog("option","title",fb.label+" requires authentication");$("#auth_prompt").dialog("open")}else{call_wizard($node,fb,$node)}}).button({icons:{primary:"ui-icon-lightbulb"}});$node.find(".button_box").append($button)}else{console.debug("Useless FEEDBACK on "+spec.keys)}}function load_ui($node){var spec=$node.data("spec.entry"),handler_class=spec.typename,handler,$ui,id,$butt,$button,pendid,$pending,$buttons;if(typeof window.Types[handler_class]!=="function"){handler_class="BaseType"}handler=new window.Types[handler_class](spec);$node.data("value_handler",handler);$ui=handler.createUI(function(){update_modified_default($node);check_current_value($node,true)});$node.find(".ui-placeholder").replaceWith($ui);pendid="pending"+_id_ify(spec.keys);$pending=$("#"+pendid);if($pending.length){handler.useVal($pending.data("value_handler").currentValue());$pending.remove()}$buttons=$('<div class="button_box"></div>').insertAfter($ui);if(spec.CHECK.undefok===1&&spec.typename!="BOOLEAN"){$node.addClass("undefinedOK");id="UOK"+_id_ify(spec.keys);$butt=$('<input type="checkbox" id="'+id+'">').appendTo($buttons);$butt.click(function(){if($(this).attr("checked")){$ui.removeAttr("disabled");$node.removeClass("disabled")}else{$ui.attr("disabled","disabled");$node.addClass("disabled")}update_modified_default($node)});handler.null_if=function(){return!$butt.attr("checked")};if(typeof spec.current_value=="undefined"||spec.current_value===null){$ui.attr("disabled","disabled");$node.addClass("disabled")}else{$butt.attr("checked","checked")}$butt.appendTo($buttons);$("<label for='"+id+"'> enable</label>").attr("title","If unchecked, "+spec.keys+" will be undefined. Check this box to give it a value.").appendTo($buttons)}$button=$('<button class="undo_button control_button">undo</button>');$button.attr("title","Reset to configured value: "+spec.current_value);$button.click(function(){handler.restoreCurrentValue();check_current_value($node,true)}).button({icons:{primary:"ui-icon-cancel"}}).hide();$button.appendTo($buttons);$button=$('<button class="default_button control_button">reset</button>');$button.attr("title","Reset to default value: "+spec["default"]);$button.click(function(){handler.restoreDefaultValue();check_current_value($node,true)}).button({icons:{primary:"ui-icon-arrowrefresh-1-w"}}).hide();$button.appendTo($buttons);if(spec.FEEDBACK){$.each(spec.FEEDBACK,function(index,fb){create_feedback(spec,fb,$node)})}$("body").trigger("configurecreate",_id_ify(spec.keys));update_modified_default($node)}function load_tab(spec,$panel){var $tab;if($panel.hasClass("spec_loaded")){return}$tab=$("#TAB"+_id_ify(spec.headline));RPC("getspec","Load: "+spec.headline,{get:{parent:{depth:spec.depth,headline:spec.headline}},depth:0},function(response){var $node=$('<div class="node"></div>'),$report;$panel.append($node);$panel.addClass("spec_loaded");if(spec.headline){$node.append("<h2>"+spec.headline+"</h2>")}if(0){$tab.removeClass("errors").removeClass("warnings");$node.data("spec.entry",spec);$report=$('<div class="reports"></div>');$report.attr("id","REP"+_id_ify(spec.headline));$node.append($report)}if(spec.desc){add_desc(spec,$node)}load_section_specs(response,$node);RPC("check_current_value","Check: "+spec.headline,{keys:[spec.headline]},checker_reports)},$panel)}function value_of(selector){var $el=$(selector);if($el.length===0){throw selector+" has not been loaded yet"}if($el.attr("type")=="checkbox"){return $el.is(":checked")}return $el.val()}function add_dependency(test,$el,cb){var name,keys=[],selector,handler;test=test.replace(/^(\w+)\s+/,function(str,p1,offset){name=p1;return""});test=test.replace(/((?:\{\w+\})+)/g,function(str,p1,offset){selector="#"+_id_ify(p1);keys.push(selector);return"value_of('"+selector+"')"});handler=function(event){try{cb($el,eval("("+test+")")?true:false)}catch(err){console.debug(err)}};$.each(keys,function(index,k){$(document).on("change",k,null,handler)});return handler}function add_desc(entry,$node){var m=/^((?:.|\n)*?\.)\s+((?:.|\n)+)$/.exec(entry.desc),$description,$more,$infob;if(m){$description=$('<div class="description">'+TML.render(m[1])+"&nbsp;</div>");$node.append($description);$more=$('<span class="closed">'+TML.render(m[2])+"</span>");$infob=$('<a class="more">... more</a>');$infob.click(function(){if($more.is(":visible")){$more.hide();$infob.text("... more")}else{$more.show();$infob.text("... less")}});$description.append($more);$description.append($infob)}else{$node.append('<div class="description">'+TML.render(entry.desc)+"</div>")}$node.append()}function load_section_specs(entries,$section){var on_ready=[],$children=null,$lis=null,created={};$.each(entries,function(index,entry){var label,$node,id,$report;if(entry.typename!="SECTION"){$node=$('<div class="node load_ui"></div>');$node.data("spec.entry",entry);if(entry.EXPERT&&entry.EXPERT==1){$node.addClass("expert");if($("#showExpert").attr("checked")!=="checked"){$node.addClass("hidden_expert")}}if(typeof entry.DISPLAY_IF!=="undefined"){on_ready.push(add_dependency(entry.DISPLAY_IF,$node,function($n,tf){if(tf){$n.removeClass("hidden_di")}else{$n.addClass("hidden_di")}}))}if(typeof entry.ENABLE_IF!=="undefined"){on_ready.push(add_dependency(entry.ENABLE_IF,$node,function($n,tf){if(tf){$n.find("input,textarea").removeAttr("disabled")}else{$n.find("input,textarea").attr("disabled","disabled")}}))}if(typeof entry.keys!=="undefined"){id=_id_ify(entry.keys);$node.addClass("keyed");if(entry.LABEL){label="<b>"+entry.LABEL+':</b><div class="keys">'+entry.keys+"</div>"}else{label="<b>"+entry.keys+":</b>"}$node.append('<div class="label">'+label+'</div><div class="ui-elem clearfix"><span class="ui-placeholder"></span></div>')}else if(entry.headline!==null){id=_id_ify(entry.headline)}$node.attr("id",id+"_block");$report=$('<div class="reports"></div>');$report.attr("id","REP"+id);$node.append($report);if(entry.desc){add_desc(entry,$node)}if(entry.LABEL){}$section.append($node)}});$.each(entries,function(index,entry){if(entry.typename=="SECTION"&&!created[entry.headline]){created[entry.headline]=true;var $li=$('<li><a href="'+json_rpc_url+'"><span class="tab" id="'+"TAB"+_id_ify(entry.headline)+'">'+entry.headline+"</span></a></li>");if(entry.EXPERT&&entry.EXPERT==1){$li.addClass("expert");if($("#showExpert").attr("checked")!=="checked"){$li.addClass("hidden_expert")}}$li.data("spec.entry",entry);if($children===null){$children=$("<div></div>");$section.append($children);$lis=$("<ul></ul>");$children.append($lis)}$lis.append($li)}});if($children!==null){$children.tabs({beforeLoad:function(event,ui){load_tab($(ui.tab).data("spec.entry"),$(ui.panel));return false}});if($section.is("#root")){$children.addClass("ui-tabs-vertical ui-helper-clearfix")}}$section.find(".node.load_ui").each(function(){load_ui($(this).removeClass("load_ui"))});$.each(on_ready,function(index,handler){handler.call()})}function search(term){var $node=$(".searchResults"),$list,$title;$list=$node.find("ol").empty();$node.find(".errors").remove();$title=$node.find(".searchTitle").text("Searching for '"+term+"'");$node.slideDown();RPC("search","Search: "+term,{search:term},function(response){var i,hit,l=response.length;if(l){for(i=0;i<l;i++){hit=response[i].join(" > ");$list.append("<li>"+hit+"</li>")}}else{$("<div class='errors'>nothing found</div>").insertAfter($list);window.setTimeout(function(){$(".searchResults").slideUp()},1e3)}},$title)}$(document).ready(function(){var $root=$("#root"),bs=foswiki.getPreference("is_bootstrapped")==="true";json_rpc_url+=foswiki.getPreference("scriptsuffix");if(!bs){$("#bootstrap_warning").remove()}$("#auth_prompt").dialog({autoOpen:false,modal:true,buttons:{Confirm:function(){$("#auth_prompt").dialog("close");auth_action()},Cancel:function(){$("#auth_prompt").dialog("close")}}});$("#confirm_prompt").dialog({autoOpen:false,modal:true,buttons:{Confirm:function(){$("#confirm_prompt").dialog("close");confirm_action()},Cancel:function(){$("#confirm_prompt").dialog("close")}}});$("#closeSearchButton").button().click(function(){$(".searchResults").slideUp()});$("#searchButton").button({icons:{primary:"ui-icon-search"},text:false}).click(function(){search($("#searchInput").val())});$("#searchInput").keypress(function(ev){if(ev.which==13){search($(this).val())}});$("#showExpert").button({disabled:true});$("#visitSite").button();$("body").on("configurecreate",function(event,id){if(id==="i-DefaultUrlHost-"||id==="i-ScriptUrlPath-"||id==="i-ScriptSuffix-"){$("#"+id).change(function(){var $vs=$("#visitSite");var url=$("#i-DefaultUrlHost-").val()+$("#i-ScriptUrlPath-").val()+"/view"+$("#i-ScriptSuffix-").val();$("#visitSite").attr("href",url).text(url)})}});$("#saveButton").button({disabled:!bs}).click(function(){confirm_action=function(){var params={wizard:"Save",method:"save",set:find_modified_values()};wizard_started(params);RPC("wizard","Save",params,function(results){wizard_reports(params,$root,results);var erc=0;$.each(results.messages,function(index,rep){if(rep.level=="errors"){erc+=1}});if(erc===0){$("#bootstrap_warning").remove();$(".value_modified").each(function(){var handler=$(this).data("value_handler");handler.commitVal();update_modified_default($(this));$(this).removeClass("value_modified")});$("#saveButton").button("disable")}},$(this))};var changed=":<ul>";if($("#bootstrap_warning").length){changed=" complete basic configuration"+changed}$(".value_modified").each(function(){var handler=$(this).data("value_handler");changed+="<li>"+handler.spec.keys+"</li>"});changed+="</ul>";$("#confirm_note").html($("#saveMessage").html());$("#confirm_note").append(changed);$("#confirm_prompt").dialog("option","title","Confirm save");$("#confirm_prompt").dialog("open")});$(document).tooltip({tooltipClass:"info",show:{effect:"show",delay:500},hide:{effect:"hide",delay:200},track:true,position:{my:"left+15 top+15",at:"left bottom",collision:"flipfit"}});$(".help_button").each(function(){$(this).button({icons:{primary:$(this).attr("name")},text:false})});RPC("getspec","Load schema",{get:{parent:{depth:0}},depth:0},function(result){$root.empty().removeClass("loading");load_section_specs(result,$root);$("#showExpert").change(function(){if(this.checked){$(".expert").each(function(){$(this).removeClass("hidden_expert")})}else{$(".expert").each(function(){$(this).addClass("hidden_expert")})}}).button("enable");RPC("check_current_value","Check all",{keys:[]},checker_reports)})});$(window).on("beforeunload",function(){if($(".value_modified").length>0){var changed="";if($("#bootstrap_warning").length){changed=" complete basic configuration\n"}$(".value_modified").each(function(){var handler=$(this).data("value_handler");changed+="   "+handler.spec.keys+"\n"});return"You have unsaved changes:\n"+changed+"Are you really sure?\n"}})})(jQuery);