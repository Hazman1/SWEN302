var jQuery,$,$dlg;var AttachDlg={preInit:function(){tinyMCEPopup.requireLangPack()},init:function(ed){if(typeof jQuery=="undefined"){var iframeBody=document.getElementsByTagName("body")[0];jQuery=parent.window.jQuery;$=jQuery;$dlg=function(selector){return parent.jQuery(selector,iframeBody)}}$dlg("#insert").click(function(){AttachDlg.insert($dlg("#attachments_select").val())});FoswikiTiny.getListOfAttachments(function(atts){var select=$dlg("#attachments_select");if(atts.length>0){for(var i=0;i<atts.length;i++){select.append('<option value="'+atts[i].name+'">'+atts[i].name+"</option>")}}else{$dlg("#general_tab").removeClass("current");$dlg("#general_panel").removeClass("current");$dlg("#upload_tab").addClass("current");$dlg("#upload_panel").addClass("current")}});var $form=$dlg("#upload_form");var url=FoswikiTiny.getScriptURL("upload");$dlg("#upload_form_topic").val(FoswikiTiny.getTopicPath());$form.submit(function(){return AttachDlg.submit(url,$form)});tinyMCEPopup.resizeToInnerSize()},insert:function(filename){var inst=tinyMCE.activeEditor;var url=FoswikiTiny.getFoswikiVar("ATTACHURL")+"/"+filename;var tmp=filename.lastIndexOf(".");if(tmp>=0)tmp=filename.substring(tmp+1,filename.length).toLowerCase();var html;if(tmp=="jpg"||tmp=="gif"||tmp=="jpeg"||tmp=="png"||tmp=="bmp"){html="<img src='"+url+"' alt='"+filename+"'>"}else{html="<a href='"+url+"'>"+filename+"</a>"}inst.execCommand("mceInsertContent",false,html);inst.nodeChanged();tinyMCEPopup.close()},submit:function(url,$form){var key_carrier=parent.document.EditForm.validation_key;if(typeof StrikeOne!=="undefined"){var nonce=key_carrier.value;if(nonce){$dlg("#validation_key").val(StrikeOne.calculateNewKey(nonce))}}$dlg("#status_frame").text("Uploading...");if(false&&typeof FormData!=="undefined"){var formData=new FormData($form[0]);jQuery.ajax({url:url,type:"POST",data:formData,mimeType:"multipart/form-data",contentType:false,processData:false,cache:false,success:function(data,textStatus,jqXHR){AttachDlg.handle_message(jqXHR.responseText)},error:function(jqXHR,textStatus,error){AttachDlg.handle_message(jqXHR.responseText)},complete:function(jqXHR,textStatus){var nonce=jqXHR.getResponseHeader("X-Foswiki-Validation");if(nonce){key_carrier.value="?"+nonce}}});return false}$form.attr("action",url);if(!$form[0].preserve_vk){$form.append('<input type="hidden" name="preserve_vk" value="1" />')}$dlg('iframe[name="upload_iframe"]').load(function(e){var doc=$(e.target.contentDocument);AttachDlg.handle_message($("body",doc).html())});return true},handle_message:function(text){var m=/OopsException\(attention\/(\w+)/.exec(text);if(m){var mel=$dlg("#"+m[1]);if(mel.length){$dlg("#status_frame").html(mel.html());return}}$dlg("#status_frame").text(text)}};AttachDlg.preInit();tinyMCEPopup.onInit.add(AttachDlg.init,AttachDlg);